// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DIRECT_DATABASE_URL")
}


model User {
  id                String     @id @default(uuid())
  walletAddress     String     @unique
  email             String?
  name              String?
  avatar            String?
  isVerified        Boolean    @default(false)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  proposals         Proposal[]
  gigs              Gig[]
}

model Gig {
  id          String   @id @default(uuid())
  title       String
  description String
  budget      Decimal  @db.Decimal(18, 2)
  tags        String[]
  clientId    String
  isFunded    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client      User     @relation(fields: [clientId], references: [id])
  proposals   Proposal[]
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Proposal {
  id               String         @id @default(uuid())
  coverLetter      String         @db.Text
  bidAmount        Decimal        @db.Decimal(18, 2)
  status           ProposalStatus @default(PENDING)
  
  gigId            String
  freelancerId     String // Mapping to User via wallet address logic in code, or direct ID relation
  
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  gig              Gig            @relation(fields: [gigId], references: [id])
  freelancer       User           @relation(fields: [freelancerId], references: [id])

  // Constraint: A freelancer can only submit one proposal per gig
  @@unique([gigId, freelancerId])
}

enum RecipientEntityType {
  VENDOR
  PARTNER
  AGENCY
  CONTRACTOR
}

enum RecipientStatus {
  ACTIVE
  INACTIVE
}

enum PayoutMethod {
  ONCHAIN
  BANK
  HYBRID
}

enum SettlementPreference {
  INSTANT
  WEEKLY
  MONTHLY
}

enum RiskTier {
  LOW
  MEDIUM
  HIGH
}

enum ApprovalPolicy {
  AUTO
  SINGLE
  MULTI
  THRESHOLD
}

enum VendorCategory {
  SOFTWARE
  HARDWARE
  SERVICES
  LOGISTICS
  MARKETING
  OTHER
}

enum PaymentTerms {
  NET0
  NET7
  NET14
  NET30
  MILESTONE_BASED
}

enum PartnerModel {
  REVENUE_SHARE
  PROFIT_SHARE
  COST_SHARE
  AFFILIATE
  REFERRAL
}

enum SettlementCycle {
  WEEKLY
  BIWEEKLY
  MONTHLY
  PER_CAMPAIGN
}

enum TrackingMethod {
  OFFCHAIN_REPORT
  ONCHAIN_METRICS
  MANUAL_APPROVAL
}

enum AgencyPayoutMode {
  MASTER_PAYEE
  SPLIT_TO_TEAM
  HYBRID
}

enum EngagementType {
  FIXED
  HOURLY
  RETAINER
}

enum KycLevel {
  NONE
  BASIC
  VERIFIED
}

enum DisputePreference {
  AUTO_ARBITRATION
  MANUAL_REVIEW
}

enum EscrowIntentStatus {
  CREATED
  FUNDED
  SUBMITTED
  RELEASED
  REFUNDED
}

model Recipient {
  id           String             @id @default(uuid())
  orgId        String?
  displayName  String
  legalName    String?
  entityType   RecipientEntityType
  billingEmail String
  country      String
  timezone     String
  referenceId  String?
  status       RecipientStatus    @default(ACTIVE)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  payout       RecipientPayout?
  accounting   RecipientAccounting?
  policy       RecipientPolicy?
  vendorProfile     RecipientProfileVendor?
  partnerProfile    RecipientProfilePartner?
  agencyProfile     RecipientProfileAgency?
  contractorProfile RecipientProfileContractor?
  splitTemplates    RecipientSplitTemplate[]
  escrowIntents     EscrowIntent[]
}

model RecipientPayout {
  id                   String               @id @default(uuid())
  recipientId          String               @unique
  preferredAsset       String
  payoutMethod         PayoutMethod
  payoutAddress        String?
  bankAccountRef       String?
  settlementPreference SettlementPreference
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  recipient            Recipient            @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientAccounting {
  id              String   @id @default(uuid())
  recipientId     String   @unique
  counterpartyCode String?
  costCenter      String?
  tags            String[]

  recipient       Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientPolicy {
  id                      String         @id @default(uuid())
  recipientId             String         @unique
  riskTier                RiskTier
  approvalPolicy          ApprovalPolicy
  maxSinglePayment        Decimal?       @db.Decimal(18, 2)
  maxMonthlyLimit         Decimal?       @db.Decimal(18, 2)
  requiresEscrowDefault   Boolean?
  requiresMilestonesDefault Boolean?

  recipient               Recipient      @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientProfileVendor {
  id               String         @id @default(uuid())
  recipientId      String         @unique
  vendorCategory   VendorCategory
  paymentTerms     PaymentTerms
  invoiceRequired  Boolean
  invoiceEmail     String?
  supportedDocuments String[]
  billToEntityName String?
  taxTreatment     String?

  recipient        Recipient      @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientProfilePartner {
  id              String         @id @default(uuid())
  recipientId     String         @unique
  partnerModel    PartnerModel
  settlementCycle SettlementCycle
  defaultSplitBps Int?
  programId       String?
  trackingMethod  TrackingMethod
  kpiTags         String[]

  recipient       Recipient      @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientProfileAgency {
  id                      String           @id @default(uuid())
  recipientId             String           @unique
  payoutMode              AgencyPayoutMode
  hasSubRecipients        Boolean
  acceptanceWindowDefault Int?
  requiresMilestones      Boolean
  milestoneTemplate       Json?

  recipient               Recipient        @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientProfileContractor {
  id                 String            @id @default(uuid())
  recipientId        String            @unique
  engagementType     EngagementType
  scopeSummary       String
  preferredPayoutAsset String
  kycLevel           KycLevel
  disputePreference  DisputePreference

  recipient          Recipient         @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model RecipientSplitTemplate {
  id                    String    @id @default(uuid())
  recipientId           String
  templateName          String
  recipientWalletOrRef  String
  bps                   Int

  recipient             Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
}

model EscrowIntent {
  id                   String             @id @default(uuid())
  recipientId          String
  entityType           RecipientEntityType
  amount               Decimal            @db.Decimal(18, 2)
  fundingAsset         String
  payoutAsset          String
  releaseCondition     String
  deadlineDays         Int
  acceptanceWindowDays Int
  enableYield          Boolean
  enableProtection     Boolean
  splitConfig          Json?
  milestoneTemplate    Json?
  notes                String?
  status               EscrowIntentStatus @default(CREATED)
  onchainIntentId      BigInt?            @unique
  evidenceHash         String?
  createdTxHash        String?
  fundedTxHash         String?
  submittedTxHash      String?
  releasedTxHash       String?
  refundedTxHash       String?
  fundedAt             DateTime?
  submittedAt          DateTime?
  releasedAt           DateTime?
  refundedAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  recipient             Recipient         @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  escrowJobMilestone    EscrowJobMilestone?
}

model EscrowEventCursor {
  id                String   @id
  lastProcessedBlock BigInt
  updatedAt         DateTime @updatedAt
}

enum ChainEventSource {
  TREASURY
  ESCROW
  YIELD_MANAGER
  REGISTRY
  SWAP
  TOKEN
}

model ChainEvent {
  id               String           @id @default(uuid())
  chainId           Int
  source            ChainEventSource
  contractAddress   String
  eventName         String
  txHash            String
  blockNumber       BigInt
  logIndex          Int
  onchainIntentId   BigInt?
  asset             String?
  amount            Decimal?        @db.Decimal(38, 18)
  data              Json?
  timestamp         DateTime?
  createdAt         DateTime         @default(now())

  @@unique([chainId, txHash, logIndex])
  @@index([chainId, source, blockNumber])
  @@index([onchainIntentId])
}

model TreasurySnapshot {
  id            String    @id @default(uuid())
  chainId        Int
  treasury       String
  assetSymbol    String?
  idle           Decimal  @db.Decimal(38, 18)
  escrowLocked   Decimal  @db.Decimal(38, 18)
  yieldDeployed  Decimal  @db.Decimal(38, 18)
  total          Decimal  @db.Decimal(38, 18)
  blockNumber    BigInt?
  timestamp      DateTime @default(now())

  @@index([chainId, treasury, timestamp])
}

model EscrowIntentState {
  id             String            @id @default(uuid())
  chainId         Int
  onchainIntentId BigInt           @unique
  status          EscrowIntentStatus
  treasury        String?
  asset           String?
  payoutAsset     String?
  amount          Decimal?         @db.Decimal(38, 18)
  escrowYieldEnabled Boolean?
  escrowShares    Decimal?         @db.Decimal(38, 18)
  updatedAt       DateTime         @updatedAt

  @@index([chainId, status])
}

model EscrowJob {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Maker / publisher address (wallet). Kept as string to avoid coupling to User table.
  createdBy        String

  // Public job listing fields
  isPublic         Boolean   @default(true)
  title            String
  description      String?
  notes            String?
  tags             String[]

  // Payment configuration for the job
  fundingAsset     String
  payoutAsset      String
  totalAmount      Decimal   @db.Decimal(18, 2)
  releaseCondition String
  enableYield      Boolean
  enableProtection Boolean

  milestones       EscrowJobMilestone[]
  participants     EscrowJobParticipant[]

  @@index([createdBy, createdAt])
  @@index([isPublic, createdAt])
}

model EscrowJobMilestone {
  id            String   @id @default(uuid())
  jobId         String
  index         Int
  title         String
  dueDays       Int?
  percentage    Int
  amount        Decimal  @db.Decimal(18, 2)

  // Each milestone corresponds to a backend escrow intent row (and later an on-chain intentId).
  escrowIntentId String? @unique

  job           EscrowJob   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  escrowIntent  EscrowIntent? @relation(fields: [escrowIntentId], references: [id], onDelete: SetNull)

  @@unique([jobId, index])
  @@index([escrowIntentId])
}

model EscrowJobParticipant {
  id        String   @id @default(uuid())
  jobId     String
  address   String
  joinedAt  DateTime @default(now())

  job       EscrowJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, address])
  @@index([address])
}
